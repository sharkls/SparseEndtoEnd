# Copyright (c) 2024 SparseEnd2End. All rights reserved @author: Thomas Von Wu.
# SparseBEV感知任务配置文件

# 任务配置
task_config {
    # 模型配置参数
    model_cfg_params {
        embedfeat_dims: 256
        sparse4d_extract_feat_shape_lc: [89760, 256]
        sparse4d_extract_feat_spatial_shapes_ld: [64, 176, 32, 88, 16, 44, 8, 22]
        sparse4d_extract_feat_level_start_index: [0, 11264, 14080, 14784, 14960, 26224, 29040, 29744, 29920, 41184, 44000, 44704, 44880, 56144, 58960, 59664, 59840, 71104, 73920, 74624, 74800, 86064, 88880, 89584]
        multiview_multiscale_deformable_attention_aggregation_path: "/share/Code/Sparse4d/deploy/dfa_plugin/lib/deformableAttentionAggr.so"
        num_classes: 10
        class_names: ["car", "truck", "bus", "trailer", "construction_vehicle", "pedestrian", "motorcycle", "bicycle", "traffic_cone", "barrier"]
    }

    # 预处理配置参数
    preprocessor_params {
        num_cams: 6
        raw_img_c: 3
        raw_img_h: 900
        raw_img_w: 1600
        model_input_img_c: 3
        model_input_img_h: 256
        model_input_img_w: 704
        # 修复：设置为与onboard版本一致的参数
        resize_ratio: 0.44
        crop_height: 140
        crop_width: 0
    }

    # 实例银行配置参数
    instance_bank_params {
        num_querys: 900
        query_dims: 11
        # 注意：kmeans_anchors 应该从二进制文件动态加载，而不是在这里硬编码
        # 实际运行时会被 parameters_parser.cpp 中的代码覆盖
        topk_querys: 600
        max_time_interval: 2.0
        default_time_interval: 0.5
        confidence_decay: 0.6
        # 新增：实例银行锚点文件路径
        instance_bank_anchor_path: "/share/Code/Sparse4d/script/tutorial/asset/sample_0_anchor_1*900*11_float32.bin"
    }

    # 后处理配置参数
    postprocessor_params {
        post_process_out_nums: 300
        post_process_threshold: 0.2
        # GPU NMS相关参数
        use_gpu_nms: true                    # 是否使用GPU NMS
        gpu_nms_threshold: 0.2              # GPU NMS IoU阈值
        max_output_boxes: 300              # 最大输出框数量
    }

    # 特征提取引擎配置
    extract_feat_engine {
        engine_path: "/share/Code/Sparse4d/deploy/engine/sparse4dbackbone.engine"
        input_names: ["img"]
        output_names: ["feature"]
    }

    # 第一帧头部引擎配置
    head1st_engine {
        engine_path: "/share/Code/Sparse4d/deploy/engine/sparse4dhead1st.engine"
        plugin_path: "/share/Code/Sparse4d/deploy/dfa_plugin/lib/deformableAttentionAggr.so"
        input_names: ["feature", "spatial_shapes", "level_start_index", "instance_feature", "anchor", "time_interval", "image_wh", "lidar2img"]
        output_names: ["tmp_outs0", "tmp_outs1", "tmp_outs2", "tmp_outs3", "tmp_outs4", "tmp_outs5", "pred_instance_feature", "pred_anchor", "pred_class_score", "pred_quality_score"]
    }

    # 第二帧头部引擎配置
    head2nd_engine {
        engine_path: "/share/Code/Sparse4d/deploy/engine/sparse4dhead2nd.engine"
        plugin_path: "/share/Code/Sparse4d/deploy/dfa_plugin/lib/deformableAttentionAggr.so"
        input_names: ["feature", "spatial_shapes", "level_start_index", "instance_feature", "anchor", "time_interval", "temp_instance_feature", "temp_anchor", "mask", "track_id", "image_wh", "lidar2img"]
        output_names: ["tmp_outs0", "pred_track_id", "tmp_outs1", "tmp_outs2", "tmp_outs3", "tmp_outs4", "tmp_outs5", "pred_instance_feature", "pred_anchor", "pred_class_score", "pred_quality_score"]
    }

    # 程序运行状态
    run_status: true
    # 是否使用半精度
    use_half_precision: false
}

# 模块配置
modules_config {
    modules {
        type: "preprocess"
        name: "ImagePreprocessor"
    }
    modules {
        type: "inference"
        name: "SparseBEV"
    }
    modules {
        type: "postprocess"
        name: "PostProcessor"
    }
}